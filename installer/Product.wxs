<?xml version="1.0" encoding="utf-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  <!--
    Product.wxs
    - Uses a harvest file (installer\harvest.wxs) that defines ComponentGroup Id="AppFiles".
    - Run heat.exe in CI to generate installer\harvest.wxs from your project's bin\Release\net48 output.
    - Keep a stable UpgradeCode between releases.
  -->
  <Product Id="*" Name="LightsOutCube" Language="1033" Version="1.0.0.0"
           Manufacturer="Gareth Richards" UpgradeCode="d2f7b0a4-6c6f-4f2d-9b1a-5b8b2f9d3c3f">
    <Package InstallerVersion="500" Compressed="yes" InstallScope="perMachine" />

    <!-- Add this Media element to satisfy harvested file references -->
    <Media Id="1" Cabinet="product.cab" EmbedCab="yes" />

    <!-- Target folder (ProgramFilesFolder\LightsOutCube) -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="INSTALLFOLDER" Name="LightsOutCube" />
      </Directory>

      <!-- Start menu / Programs folder for shortcuts -->
      <Directory Id="ProgramMenuFolder">
        <!-- Start menu subfolders are provided by the harvested fragment (harvest.wxs). Do not redefine here. -->
      </Directory>
    </Directory>

    <!--
      harvest.wxs (generated by heat) should contain a Fragment that defines:
        <DirectoryRef Id="INSTALLFOLDER">
          <ComponentGroup Id="AppFiles" Directory="INSTALLFOLDER"> ... </ComponentGroup>
        </DirectoryRef>
      This installer references that ComponentGroup below.
    -->
    <!-- include the harvested fragment at build time; ensure candle sees both files -->
    <!-- Example: candle installer\Product.wxs installer\harvest.wxs -->
    <!-- The harvested fragment (installer\harvest.wxs) is compiled as a separate source
         and linked together with this Product.wxs by passing both files to candle.
         Do not use preprocessor include here because harvest.wxs is a standalone
         WiX document (generated by heat) and should be provided as a separate
         input to the compiler. -->

    <!-- Shortcuts & registration (non-advertised desktop/start-menu shortcut) -->
    <!-- Reference the start-menu folder created by the harvest file -->
    <DirectoryRef Id="LightsOutCubeProgramsFolder">
      <Component Id="cmp_Shortcut" Guid="b5b6f7a1-1d2e-4fd6-9fb9-3c8e2a9d7f4b">
        <!-- Non-advertised shortcut (Target points to the installed exe path). -->
        <Shortcut Id="desktopShortcut" Name="Lights Out Cube"
                  Directory="LightsOutCubeProgramsFolder"
                  WorkingDirectory="INSTALLFOLDER"
                  Target="[INSTALLFOLDER]LightsOutCube.exe" />
        <!-- Remove the shortcut file on uninstall -->
        <RemoveFile Id="RemoveDesktopShortcut" Name="Lights Out Cube.lnk" Directory="LightsOutCubeProgramsFolder" On="uninstall" />

        <RegistryValue Root="HKCU" Key="Software\LightsOutCube" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <!-- Feature tree: include harvested app files and the shortcut component -->
    <Feature Id="DefaultFeature" Title="LightsOutCube" Level="1">
      <ComponentRef Id="cmp_Shortcut" />
      <ComponentGroupRef Id="AppFiles" />
    </Feature>

    <!-- Major upgrade support so new MSI versions can remove old -->
    <MajorUpgrade AllowDowngrades="no" DowngradeErrorMessage="A newer version of [ProductName] is already installed." />

    <!-- .NET Framework 4.8 detection via registry; Release >= 528040 indicates 4.8 -->
    <Property Id="NETFRAMEWORK48">
      <RegistrySearch Id="NetFramework48Release"
                      Root="HKLM"
                      Key="SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full"
                      Name="Release"
                      Type="raw" />
    </Property>

    <Condition Message=".NET Framework 4.8 or later is required.">
      <![CDATA[Installed OR (NETFRAMEWORK48 AND NETFRAMEWORK48 >= "528040")]]>
    </Condition>

    <!-- Metadata for Add/Remove Programs -->
    <Property Id="ARPCONTACT" Value="Gareth Richards" />
    <Property Id="ARPPRODUCTICON" Value="appIcon.ico" /> <!-- optional, include file in harvest if used -->

  </Product>
</Wix>