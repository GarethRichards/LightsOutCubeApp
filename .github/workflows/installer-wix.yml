name: Build Installer (WiX)

on:
  push: { branches: [ main ] }

jobs:
  build-installer:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1

      - name: Restore & Build app
        run: |
          nuget restore LightsOutCube.sln
          msbuild LightsOutCube.sln /p:Configuration=Release /m

      - name: Install WiX (choco)
        run: choco install wixtoolset -y

      - name: Build WiX (heat + candle + light)
        run: |
          $env:WIX = (Get-ChildItem 'C:\Program Files (x86)\WiX Toolset*v*' | Select-Object -First 1).FullName
          Write-Host "Using WiX at: $env:WIX"

          # Generate harvest.wxs from the built application output
          & "$env:WIX\bin\heat.exe" dir "src\bin\Release" -ag -scom -sreg -sfrag -gg -cg AppFiles -dr INSTALLFOLDER -out "installer\harvest.wxs"

          # Ensure output directory for wixobj files
          New-Item -ItemType Directory -Force -Path installer\obj | Out-Null

          # Compile both Product.wxs and generated harvest.wxs; -out is a directory when multiple inputs
          & "$env:WIX\bin\candle.exe" -dHarvestExists=1 installer\Product.wxs installer\harvest.wxs -out installer\obj\

          # Link to produce MSI from generated wixobj files
          & "$env:WIX\bin\light.exe" installer\obj\Product.wixobj installer\obj\harvest.wixobj -out installer\LightsOutCube.msi

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: lightsoutcube-msi
          path: installer\LightsOutCube.msi