name: Build and Package (WiX)

on:
  push:
    branches: [ main ]

jobs:
  build-app:
    name: Build application
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1

      - name: Restore & Build app
        run: |
          nuget restore LightsOutCube.sln
          msbuild LightsOutCube.sln /p:Configuration=Release /m

      - name: Upload app artifacts
        uses: actions/upload-artifact@v4
        with:
          name: app-artifact
          # upload project outputs for .NET Framework 4.8 builds (net48)
          path: |
            src/**/bin/Release/net48/**

  build-installer:
    name: Build installer (WiX)
    runs-on: windows-latest
    needs: build-app
    steps:
      - uses: actions/checkout@v4

      - name: Download app artifacts
        uses: actions/download-artifact@v4
        with:
          name: app-artifact
          path: dist

      - name: Install WiX (choco)
        run: choco install wixtoolset -y

      - name: Build WiX (heat + candle + light)
        run: |
          $env:WIX = (Get-ChildItem 'C:\Program Files (x86)\WiX Toolset*v*' | Select-Object -First 1).FullName
          Write-Host "Using WiX at: $env:WIX"

          # locate the built exe inside the downloaded artifact (dist)
          $appExe = Get-ChildItem -Path dist -Recurse -Filter LightsOutCube.exe | Select-Object -First 1
          if (-not $appExe) {
            Write-Error "LightsOutCube.exe not found under 'dist'. Listing dist for debugging:"
            Get-ChildItem -Path dist -Recurse | ForEach-Object { Write-Host $_.FullName }
            exit 1
          }
          $appOut = $appExe.DirectoryName
          Write-Host "Harvesting files from: $appOut"

          # generate harvest.wxs from the exact output folder
          # use -var to make Source paths use a preprocessor variable we can define when compiling
          & "$env:WIX\bin\heat.exe" dir $appOut -ag -scom -sreg -sfrag -gg -cg AppFiles -dr INSTALLFOLDER -var var.SourceDir -out "installer\harvest.wxs"

          # ensure object folder for wixobj files
          New-Item -ItemType Directory -Force -Path installer\obj | Out-Null

          # compile both Product.wxs and generated harvest.wxs into installer\obj\
          # compile with SourceDir preprocessor define so harvested Source paths resolve
          & "$env:WIX\bin\candle.exe" -ext WixNetFxExtension -dSourceDir="$appOut" installer\Product.wxs installer\harvest.wxs -out installer\obj\

          # link wixobj files into an MSI
          & "$env:WIX\bin\light.exe" -ext WixNetFxExtension installer\obj\Product.wixobj installer\obj\harvest.wixobj -out installer\LightsOutCube.msi

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: lightsoutcube-msi
          path: installer\LightsOutCube.msi