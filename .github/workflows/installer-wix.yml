name: Build and Package (WiX)

on:
  push:
    branches: [ main ]

jobs:

  build-installer:
    name: Build installer (WiX)
    runs-on: windows-latest
    needs: build-windows
    steps:
      - uses: actions/checkout@v4

      - name: Download app artifacts
        uses: actions/download-artifact@v4
        with:
          name: app-artifact
          path: dist

      - name: Install WiX (choco)
        run: choco install wixtoolset -y

      - name: Build WiX (heat + candle + light)
        run: |
          $env:WIX = (Get-ChildItem 'C:\Program Files (x86)\WiX Toolset*v*' | Select-Object -First 1).FullName
          Write-Host "Using WiX at: $env:WIX"

          # locate the built exe inside the downloaded artifact (dist)
          $appExe = Get-ChildItem -Path dist -Recurse -Filter LightsOutCube.exe | Select-Object -First 1
          if (-not $appExe) {
            Write-Error "LightsOutCube.exe not found under 'dist'. Listing dist for debugging:"
            Get-ChildItem -Path dist -Recurse | ForEach-Object { Write-Host $_.FullName }
            exit 1
          }
          $appOut = $appExe.DirectoryName
          Write-Host "Harvesting files from: $appOut"

          # generate harvest.wxs from the exact output folder
          # use -var to make Source paths use a preprocessor variable we can define when compiling
          # use -srd to suppress the harvested root directory so files are placed directly into INSTALLFOLDER
          & "$env:WIX\bin\heat.exe" dir $appOut -ag -scom -sreg -sfrag -srd -gg -cg AppFiles -dr INSTALLFOLDER -var var.SourceDir -out "installer\harvest.wxs"

          # ensure object folder for wixobj files
          New-Item -ItemType Directory -Force -Path installer\obj | Out-Null

          # path to NetFx extension DLL (use only the explicit DLL path to avoid loading the extension twice)
          $netfxExt = Join-Path $env:WIX "bin\WixNetFxExtension.dll"
          if (-not (Test-Path $netfxExt)) {
            Write-Error "WixNetFxExtension.dll not found at $netfxExt"
            exit 1
          }

          # compile both Product.wxs and generated harvest.wxs into installer\obj\
          # compile with SourceDir preprocessor define so harvested Source paths resolve
          & "$env:WIX\bin\candle.exe" -ext $netfxExt -dSourceDir="$appOut" installer\Product.wxs installer\harvest.wxs -out installer\obj\

          # list produced wixobj files for debugging and verify Product.wixobj exists
          Get-ChildItem -Path installer\obj -Filter *.wixobj | ForEach-Object { Write-Host "Produced: $($_.FullName)" }
          if (-not (Test-Path installer\obj\Product.wixobj)) {
            Write-Error "Product.wixobj missing after candle"
            exit 1
          }

          # link wixobj files into an MSI using the same explicit extension DLL (only load once)
          & "$env:WIX\bin\light.exe" -ext $netfxExt -ext "$env:WIX\bin\WixUtilExtension.dll" installer\obj\Product.wixobj installer\obj\harvest.wixobj -out installer\LightsOutCube.msi

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: lightsoutcube-msi
          path: installer\LightsOutCube.msi